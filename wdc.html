<!DOCTYPE html>
<html>
<head>
  <title>AiAshal Products Live Connector</title>
  <meta charset="utf-8">
  <script src="https://public.tableau.com/javascripts/api/tableauwdc-2.3.latest.js"></script>
  <style>
    body { font-family: Arial; text-align: center; padding: 50px; background: #f4f4f4; }
    h2 { color: #007acc; }
    button { padding: 12px 24px; font-size: 16px; background: #007acc; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 20px; }
    button:hover { background: #005a99; }
  </style>
</head>
<body>
  <h2>ربط بيانات المنتجات من AiAshal</h2>
  <p>اضغط الزر لجلب البيانات مباشرة من نظامك</p>
  <button id="submitButton">جلب البيانات الآن</button>

  <script>
    (function() {
      var myConnector = tableau.makeConnector();

      myConnector.getSchema = function(schemaCallback) {
        var cols = [
          { id: "id", dataType: tableau.dataTypeEnum.int },
          { id: "name", alias: "اسم المنتج", dataType: tableau.dataTypeEnum.string },
          { id: "sku", alias: "رمز المنتج", dataType: tableau.dataTypeEnum.string },
          { id: "category", alias: "الفئة", dataType: tableau.dataTypeEnum.string },
          { id: "sub_category", alias: "الفئة الفرعية", dataType: tableau.dataTypeEnum.string },
          { id: "brand", alias: "الماركة", dataType: tableau.dataTypeEnum.string },
          { id: "unit", alias: "الوحدة", dataType: tableau.dataTypeEnum.string },
          { id: "current_stock", alias: "المخزون الحالي", dataType: tableau.dataTypeEnum.float },
          { id: "min_price", alias: "أقل سعر", dataType: tableau.dataTypeEnum.float },
          { id: "max_price", alias: "أعلى سعر", dataType: tableau.dataTypeEnum.float },
          { id: "is_inactive", alias: "غير نشط", dataType: tableau.dataTypeEnum.string }
        ];

        var table = { id: "AiAshalProducts", alias: "منتجات AiAshal", columns: cols };
        schemaCallback([table]);
      };

      myConnector.getData = function(table, doneCallback) {
        fetch("https://ashaldeoms.com/AiAshal/api/products", {
          headers: { "Accept": "application/json" }
        })
        .then(res => {
          if (!res.ok) throw new Error("فشل الاتصال بالخادم");
          return res.json();
        })
        .then(data => {
          table.appendRows(data);
          doneCallback();
        })
        .catch(err => {
          tableau.abortWithError("خطأ: " + err.message);
        });
      };

      tableau.registerConnector(myConnector);

      document.getElementById("submitButton").addEventListener("click", function() {
        tableau.connectionName = "AiAshal Live Products";
        tableau.submit();
      });
    })();
  </script>
</body>
</html>
